<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Grocery Buddy</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; text-align: center; }
    input, button { padding: 10px; margin: 5px; border-radius: 5px; font-size: 16px; }
    #app, #groupArea, #shoppingListArea { display: none; }
    .toggle { width: 40px; height: 20px; border-radius: 20px; background-color: #ccc; position: relative; cursor: pointer; display: inline-block; transition: 0.3s; }
    .toggle::before { content: ""; position: absolute; width: 18px; height: 18px; left: 1px; top: 1px; background-color: white; border-radius: 50%; transition: transform 0.3s ease; }
    .toggle.on { background-color: #333; }
    .toggle.on::before { transform: translateX(20px); }
    table { width: 100%; max-width: 600px; margin: 20px auto; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
  </style>
</head>
<body>
  <h1 id="welcome">Grocery Buddy</h1>

  <div id="auth">
    <input type="text" id="displayName" placeholder="Username (e.g. Arjun)"><br>
    <input type="email" id="email" placeholder="Email"><br>
    <input type="password" id="password" placeholder="Password"><br>
    <button onclick="register()">Register</button>
    <button onclick="login()">Login</button>
  </div>

  <div id="app">
    <h2 id="userGreeting"></h2>

    <div id="groupArea">
      <input type="text" id="groupName" placeholder="Create/Join Group">
      <button onclick="joinGroup()">Join</button>
    </div>

    <div id="shoppingListArea">
      <input type="text" id="itemInput" placeholder="Add items, separated by commas">
      <button onclick="addItems()">Add</button>
      <table>
        <thead><tr><th></th><th>Item</th><th>Picked By</th><th>Time</th></tr></thead>
        <tbody id="list"></tbody>
      </table>
      <button onclick="clearAll()">Clear All</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
apiKey: "AIzaSyDtUjUfjd8kOz4uelvt3-We3W2a0BqNUpA",
      authDomain: "grocery-57318.firebaseapp.com",
      databaseURL: "https://grocery-57318-default-rtdb.firebaseio.com",
      projectId: "grocery-57318",
      storageBucket: "grocery-57318.firebasestorage.app",
      messagingSenderId: "577584441442",
      appId: "1:577584441442:web:b96844f850d2c0c404893b",
      measurementId: "G-SZW4G9WVHD"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser = null;
    let groupId = null;

    function register() {
      const name = displayName.value;
      const email = email.value;
      const password = password.value;
      auth.createUserWithEmailAndPassword(email, password).then(res => {
        return res.user.updateProfile({ displayName: name });
      }).then(() => {
        alert("Registered and logged in!");
        initApp();
      }).catch(err => alert(err.message));
    }

    function login() {
      const email = email.value;
      const password = password.value;
      auth.signInWithEmailAndPassword(email, password).then(() => {
        initApp();
      }).catch(err => alert(err.message));
    }

    function initApp() {
      auth.onAuthStateChanged(user => {
        if (user) {
          currentUser = user;
          document.getElementById('auth').style.display = 'none';
          document.getElementById('app').style.display = 'block';
          userGreeting.textContent = `Welcome, ${user.displayName}`;
        }
      });
    }

    function joinGroup() {
      groupId = groupName.value.trim();
      if (!groupId) return alert("Enter group name");
      document.getElementById('groupArea').style.display = 'none';
      document.getElementById('shoppingListArea').style.display = 'block';
      listen();
    }

    function addItems() {
      const raw = itemInput.value;
      const items = raw.split(',').map(i => i.trim()).filter(i => i);
      items.forEach(item => {
        const id = Date.now() + '-' + Math.random().toString(36).substr(2,5);
        db.ref(`groups/${groupId}/items/${id}`).set({
          text: item,
          picked: false,
          who: '',
          ts: 0
        });
      });
      itemInput.value = '';
    }

    function toggleItem(id, itm) {
      const isPicked = !itm.picked;
      db.ref(`groups/${groupId}/items/${id}`).update({
        picked: isPicked,
        who: isPicked ? currentUser.displayName : '',
        ts: isPicked ? Date.now() : 0
      });
    }

    function clearAll() {
      db.ref(`groups/${groupId}/items`).remove();
    }

    function listen() {
      db.ref(`groups/${groupId}/items`).on('value', snap => {
        const items = snap.val() || {};
        const tbody = document.getElementById('list');
        tbody.innerHTML = '';
        Object.entries(items).forEach(([id, itm]) => {
          const tr = document.createElement('tr');
          const toggle = document.createElement('div');
          toggle.className = 'toggle' + (itm.picked ? ' on' : '');
          toggle.onclick = () => toggleItem(id, itm);
          tr.innerHTML = `<td></td><td>${itm.text}</td>`;
          tr.children[0].appendChild(toggle);
          tr.insertCell(2).textContent = itm.picked ? itm.who : '—';
          tr.insertCell(3).textContent = itm.ts ? new Date(itm.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '—';
          tbody.appendChild(tr);
        });
      });
    }
  </script>
</body>
</html>
